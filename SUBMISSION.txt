作品名称：全球边缘神谕（Global Edge Oracle）

作品访问 URL：https://esa-ai-generator.7d7df28e.er.aliyun-esa.net
GitHub 公共仓库地址：https://github.com/liuyve552/esa-ai-generator

官方声明（必须）：
本项目由阿里云 ESA 提供加速、计算和保护。

（同项目重复提交）本次优化点（2026-01-20）：
- EdgeKV 应用场景深化（从 2 个扩展到 7 个）：新增全局实时统计（全球/城市/模式维度，TTL=48h）、边缘速率限制（IP-based 30次/分钟，EdgeKV 作为分布式计数器）、用户偏好存储（语言/模式/主题，TTL=30天，全球节点同步）
- 性能可视化增强：新增 PerformanceComparison 组件（边缘延迟 vs 中心化延迟对比，节省时间/成本可视化）、CacheHitDashboard 组件（L1内存/L2EdgeKV/L3生成三级缓存架构展示）
- API 端点扩展：新增 /api/user/prefs（GET/POST 用户偏好管理）、/api/stats/global|city|mode（实时统计查询，EdgeKV 数据源）
- 首屏性能优化：Amap 地图服务预连接（DNS+TCP提前建立，节省 200-500ms）、OraclePage 组件懒加载（首屏 JS 体积减少）、Leaflet/Framer Motion 异步分割（延迟加载约 250KB），预期首屏加载时间减少 30-50%
- 地图显示优化：切换到高德地图（Amap）瓦片服务（国内稳定），调整初始缩放级别（zoom=4，区域视图直接可见）

（同项目重复提交）上次优化点（2026-01-10）：
- 用户态持久化（≥7 天）：新增 /api/user/daily、/api/user/history 写入 EdgeKV（TTL≈9天）；匿名 UID（localStorage）标识用户，localStorage 兜底
- /result 复测增强：/result 支持 id/d 分享落地，优先 /api/share（EdgeKV）读取，404 自动 fallback /api/replay?d=...；打开时上报 /api/view/{id} 浏览量
- 数据安全写入：对 daily envelope / history item 做 schema sanitize（字段规校验 + 截断），历史去重并限制最多 12 条，避免脏数据污染 KV
- 可观测与一致性：ResultView 上报 UID/同步来源（EdgeKV or local）与历史条数到 DebugPanel；/result 再生成补齐 mood/moodText/weather 参数确保输出一致

一句话简介：
把「定位 → 天气 → 生成（AI/模板）→ 缓存 → 分享」全链路搬到阿里云 ESA 边缘节点，做成“打开即生成、可打卡、可导出海报、可复测”的病毒式边缘应用。

评委 1 分钟验收路径（零输入）：
1) 打开首页：立刻看到「零输入演示（自动生成）」卡片（无需输入/无需权限）
2) 点击「打开完整结果」：查看
   - 全球节点 POP（城市/距离）与边缘延迟
   - 多级缓存层级命中（内存/KV/实时生成）与 TTL
   - 延迟对比图（边缘 vs 中心模拟基线）
   - “今日小任务（可打卡）”与进度
   - 可传播动作：下载海报（同时复制分享链接）
3) 切换模式（今日神谕/旅行助手/专注清单/情绪安抚/社交卡片），不输入直接点「生成」：输出明显不同
4) 同一城市 + 同一模式 + 同一心情（同一天）再生成一次：预期命中内存/KV，端到端延迟显著降低
5) 打开分享链接多次刷新：不出现 {"error":"Not found"}（分享快照 + 404 回放兜底）

示例提示词（可选，不输入也能演示）：
- 给我一份今天的本地出行建议：路线、时间、注意事项，结合实时天气
- 给我一个 25 分钟专注清单：开始前/进行中/结束后分别做什么
- 写一段适合发朋友圈的短文，结合我所在城市与实时天气

技术实现与亮点（对应评审维度）：
【创意卓越】
- 边缘纹章（Sigil）：由 mode + 日期 + 城市 + 天气种子生成的可视化符号，让“每个人的边缘结果都不一样”
- 每日小任务（打卡）：把一次性生成升级为可持续互动与留存
- 海报导出：把结果变成可传播素材，便于社交平台扩散

【应用价值】
- 五种模式直连真实场景：旅行/专注/安抚/社交卡片/今日神谕
- 无 Key 也好用：不填 DASHSCOPE_API_KEY 自动降级模板，保证演示稳定；有 Key 则切到通义千问
- 分享/复测友好：分享链接内嵌快照，可回放，避免评委复测 404

【技术探索】
- 全链路边缘化：Geo（Header 优先，缺失时 IP API 兜底）→ Weather → AI/模板 → 多级缓存 → Share
- 多级 KV 缓存：key = ${mode}-${city}-${weatherCode}-${moodHash}-${dateSlice}，TTL=86400s（每日刷新）
- 边缘流式：Response Streaming（ReadableStream）逐 token 返回；结束后落 KV，二次访问接近 0ms
- POP 可观测：Request.cf.colo / headers 获取节点 + 城市映射 + 粗距离，直观证明就近计算

环境变量（可选）：
- DASHSCOPE_API_KEY：通义千问 DashScope Key（可空）
- AI_TEXT_MODEL：默认 qwen-max

合规声明：
- 作品为参赛者原创，不抄袭、不作假、不侵权；仅使用合法第三方 API/素材用于功能实现与展示。
