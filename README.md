# 全球边缘神谕（Global Edge Oracle）

> 官方声明（必须）：本项目由阿里云 ESA 提供加速、计算和保护。

- 在线地址：https://esa-ai-generator.7d7df28e.er.aliyun-esa.net
- GitHub：https://github.com/liuyve552/esa-ai-generator

![阿里云ESA Pages，构建、加速并保护你的网站](./public/esa-pages-banner.png)

一句话简介：把「定位 → 天气 → 生成（AI/模板）→ 缓存 → 分享」全链路搬到 ESA 边缘节点，做成“打开即生成、可打卡、可导出海报、可复测”的病毒式边缘应用。

## 评委 1 分钟验收（零输入）

1. 打开首页：看到「零输入演示（自动生成）」卡片（无需输入/无需权限）。
2. 点击「打开完整结果」：确认
   - 全球 POP 节点（城市/距离）与边缘延迟
   - 缓存命中（内存 / KV / 实时生成）与 TTL（86400s）
   - “今日小任务（可打卡）”与进度
   - 下载海报 / 朗读 / 复制分享链接（分享页可复测）
3. 返回首页，切换模式（今日神谕/旅行助手/专注清单/情绪安抚/社交卡片），不输入直接点「生成」：输出明显不同。
4. 同一城市 + 同一模式 + 同一心情（同一天）再生成：应命中内存/KV，端到端明显更快。
5. 用分享链接在新标签页多次打开/刷新：不出现 `{"error":"Not found"}`（`d` 快照回放兜底）。

## 本次（同项目重复提交）优化点（2026-01-19）

### 技术探索深度提升

**1. EdgeKV 应用场景扩展**
- ✅ **全局实时统计**：使用 EdgeKV 存储全球/城市/模式维度的实时使用数据，展示社交证明
- ✅ **边缘速率限制**：基于 IP 的速率限制（30次/分钟），EdgeKV 作为分布式计数器，展示边缘安全能力
- ✅ **用户偏好存储**：用户配置（语言/模式/主题）存储在 EdgeKV，全球节点同步，TTL=30天
- ✅ **分布式数据存储**：EdgeKV 从"缓存工具"升级为"配置中心+计数器+安全组件"

**2. 性能可视化增强**
- ✅ **性能对比组件**（`PerformanceComparison.tsx`）：直观展示边缘延迟 vs 中心化延迟，包含节省时间百分比
- ✅ **缓存架构仪表盘**（`CacheHitDashboard.tsx`）：可视化 L1/L2/L3 三级缓存，教育用户理解多级缓存工作原理
- ✅ **统计数据展示**：DebugPanel 中展示今日全球/城市/模式使用次数，标识数据来源（EdgeKV/模拟）

**3. API 端点新增**
- `/api/user/prefs`（GET/POST/PUT）：用户偏好配置管理
- `/api/generate`：新增速率限制检查 + 统计记录

**4. 安全与可靠性**
- 边缘前置速率限制，保护 AI 生成端点
- 标准 HTTP 429 响应，含 `X-RateLimit-*` 头
- Fail-open 策略：KV 不可用时优雅降级

**技术亮点：**
- EdgeKV 应用深度大幅提升（5种应用场景）
- 边缘安全能力展示（速率限制）
- 性能优势可视化（对比图表）
- 用户价值增强（实时统计、个性化配置）

---

## 上次优化点（2026-01-08）

- 多级 KV 缓存：L1 内存 Map → L2 ESA EdgeKV（TTL=86400s）→ L3 实时生成，结果卡展示命中层级与耗时
- Edge Streaming：`/api/generate?stream=1` 使用 NDJSON/ReadableStream，前端逐 token 渲染
- 全球节点展示：优先 `x-esa-node` / `Request.cf.colo` 获取 POP，映射城市并粗算距离
- UI 收尾：统一玻璃卡片风格（任务/海报），自绘下拉组件，新增背景主题色切换

## 核心功能

- 五种模式：今日神谕 / 旅行助手 / 专注清单 / 情绪安抚 / 社交卡片
- 边缘纹章（Sigil）：由 mode + 日期 + 城市 + 天气种子生成的可视化符号
- 今日小任务（可打卡）：将输出变成可持续互动与留存
- 可传播动作：下载海报 / 系统分享 / 朗读 / 收藏 / 复制分享链接

## 可选配置（不配也能演示）

- 环境变量：
  - `DASHSCOPE_API_KEY`：通义千问 DashScope Key（可空；为空则模板降级）
  - `AI_TEXT_MODEL`：默认 `qwen-max`
- ESA EdgeKV（推荐）：
  - 控制台启用 EdgeKV，并创建 namespace `esa-ai-generator`（与 `edge/index.js` 的 `KV_NAMESPACE` 一致）
  - 不启用 KV 时会退回到内存缓存（重启会丢，但功能仍可演示）

## 合规声明

- 作品为参赛者原创，不抄袭、不作假、不侵权。
- 第三方数据源（天气/地图/地理 IP）仅用于合法范围内的接口调用与展示。
